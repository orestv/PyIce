#!/usr/bin/python2

import gtk, pygtk
import gobject
import threading
from retriever import Retriever

class ClientWindow(gtk.Window):
    def __init__(self):
        super(ClientWindow, self).__init__()
        self.connect('destroy', self.destroy)

        host_port = self._request_server_address()
        if not host_port:
            quit()

        self._create_gui()

    def _load_collection(self):
        class CollectionFiller(threading.Thread):
            def __init__(self):
                threading.Thread.__init__(self)

        def fill_collection():
            col = self._r.get_collection()

    def _request_server_address(self):
        dlg = gtk.Dialog('Server hostname and port', self, 0,
                         (gtk.STOCK_CANCEL, gtk.RESPONSE_REJECT,
                          gtk.STOCK_OK, gtk.RESPONSE_ACCEPT))

        tbl = gtk.Table(2, 2, False)

        eHost = gtk.Entry()
        eHost.set_text('localhost')
        ePort = gtk.Entry()
        ePort.set_text('30000')

        tbl.attach(gtk.Label('Hostname'), 0, 1, 0, 1)
        tbl.attach(eHost, 1, 2, 0, 1)
        tbl.attach(gtk.Label('Port'), 0, 1, 1, 2)
        tbl.attach(ePort, 1, 2, 1, 2)

        dlg.vbox.pack_end(tbl)

        dlg.show_all()

        while 1:
            ret = dlg.run()
            if ret == gtk.RESPONSE_REJECT:
                return None
            elif ret == gtk.RESPONSE_ACCEPT:
                host = eHost.get_text()
                port = ePort.get_text()
                try:
                    port = int(port)
                except ValueError:
                    continue
                dlg.destroy()
                return (host, port)


    def _create_gui(self):
        self.set_size_request(800, 600)
        self.set_position(gtk.WIN_POS_CENTER)

        self.add(self._create_window_toplevel())        

        self.show_all()

    def _create_window_toplevel(self):
        tbl = gtk.Table(2,2,False)
        tbl.set_col_spacings(5)
        tbl.set_row_spacings(5)

        self._tvPlaylist, self._lsPlaylist = self.create_playlist_view()
        self._tvCollection, self._lsCollection = self.create_collection_view()

        sw = gtk.ScrolledWindow()
        sw.add_with_viewport(self._tvPlaylist)

        tbl.attach(sw, 0, 1, 0, 1)


        sw = gtk.ScrolledWindow()
        sw.add_with_viewport(self._tvCollection)

        tbl.attach(sw, 1, 2, 0, 1)

        return tbl


    def create_collection_view(self):
        tvCollection = gtk.TreeView()

        columns = [{'title': 'Path', 'type': str},
                   {'title': 'Artist-Title', 'type': str}]

        col_types = [x['type'] for x in columns]

        print col_types
        lsCollection = gtk.ListStore(*col_types)

        for i in range(len(columns)):
            col = columns[i]
            renderer = gtk.CellRendererText()
            c = gtk.TreeViewColumn(col['title'], renderer)
            tvCollection.append_column(c)
            c.add_attribute(renderer, 'text', i)

        tvCollection.set_model(lsCollection)

        return tvCollection, lsCollection

    def create_playlist_view(self):
        tvPlaylist = gtk.TreeView()

        columns = [{'title': 'Song', 'type': str},
                   {'title': 'Length', 'type': str}]

        col_types = [x['type'] for x in columns]

        print col_types
        lsPlaylist = gtk.ListStore(*col_types)

        for i in range(len(columns)):
            col = columns[i]
            renderer = gtk.CellRendererText()
            c = gtk.TreeViewColumn(col['title'], renderer)
            tvPlaylist.append_column(c)
            c.add_attribute(renderer, 'text', i)

        tvPlaylist.set_model(lsPlaylist)

        return tvPlaylist, lsPlaylist


    def destroy(self, widget):
        gtk.main_quit()


if __name__ == '__main__':
    c = ClientWindow()
    gobject.threads_init()
    gtk.main()

